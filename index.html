<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator Nota & Surat Jalan â€“ Rapa Cement & GRC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- â”€â”€ AUTH LOGIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="auth-overlay" class="auth-overlay">
      <div class="auth-card">
        <img src="rapa-logo.png" alt="Logo" class="auth-logo" />
        <h2>Login Admin</h2>
        <p>Silakan masuk untuk mengakses generator.</p>
        <form id="login-form">
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="login-email"
              required
              placeholder="admin@rapa.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="login-pwd"
              required
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>
          <button
            type="submit"
            class="btn-primary"
            style="margin-top: 10px; width: 100%"
          >
            Masuk
          </button>
          <p id="login-error" class="error-text" style="display: none"></p>
        </form>
      </div>
    </div>

    <!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header class="app-header">
      <img src="rapa-logo.png" alt="Logo" />
      <h1>Generator Dokumen <span>Rapa Cement &amp; GRC</span></h1>
      <button
        class="btn-logout"
        onclick="handleLogout()"
        style="margin-left: auto"
      >
        ğŸšª Logout
      </button>
    </header>

    <!-- â”€â”€ MAIN BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="app-body">
      <!-- â•â•â•â• LEFT: FORM PANEL â•â•â•â• -->
      <div class="panel-form">
        <div class="panel-form-inner">
          <!-- Tab -->
          <div class="tab-group">
            <button
              class="tab-btn active"
              data-tab="nota"
              onclick="switchTab('nota')"
            >
              ğŸ“„ Nota Penjualan
            </button>
            <button class="tab-btn" data-tab="sj" onclick="switchTab('sj')">
              ğŸšš Surat Jalan
            </button>
          </div>

          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ FORM NOTA â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div id="form-nota">
            <p class="section-title">Info Dokumen</p>
            <div class="form-row">
              <div class="form-group">
                <label>No. Nota</label>
                <div class="nomor-row">
                  <input
                    type="text"
                    id="nota-nomor"
                    placeholder="NP-202502-001"
                  />
                  <button
                    class="btn-sm"
                    onclick="
                      generateNewNomor('nota_counter', 'NP', 'nota-nomor')
                    "
                  >
                    â†» Baru
                  </button>
                  <button
                    class="btn-sm"
                    title="Kembali ke nomor sebelumnya"
                    onclick="
                      decrementSequence('nota_counter', 'NP', 'nota-nomor')
                    "
                  >
                    â¬…ï¸
                  </button>
                  <button
                    class="btn-sm btn-danger-outline"
                    onclick="resetSequence('nota_counter', 'NP', 'nota-nomor')"
                  >
                    ğŸ—‘ï¸ Reset
                  </button>
                </div>
              </div>
            </div>
            <div class="form-row cols-2">
              <div class="form-group">
                <label>Tanggal</label>
                <input type="date" id="nota-tgl" />
              </div>
              <div class="form-group">
                <label>No. PO</label>
                <input type="text" id="nota-po" placeholder="PO-xxx" />
              </div>
            </div>

            <p class="section-title">Daftar Barang</p>
            <div class="items-form-wrap">
              <table class="items-form-table">
                <thead>
                  <tr>
                    <th style="width: 22px">#</th>
                    <th style="width: 80px">Tipe</th>
                    <th>Nama Barang</th>
                    <th style="width: 52px">PCs</th>
                    <th style="width: 52px">M2</th>
                    <th style="width: 90px">Harga (Rp)</th>
                    <th style="width: 80px">Jumlah</th>
                    <th style="width: 24px"></th>
                  </tr>
                </thead>
                <tbody id="nota-items-tbody"></tbody>
              </table>
            </div>
            <button class="btn-add-row" onclick="addNotaRow()">
              + Tambah Barang
            </button>

            <p class="section-title">Pembayaran</p>
            <div class="summary-row">
              <label>DP (Rp)</label>
              <input
                type="text"
                id="nota-dp"
                placeholder="0"
                style="width: 140px; text-align: right"
                oninput="updatePreview()"
              />
            </div>
            <div class="summary-row">
              <label>Ongkir (Rp)</label>
              <input
                type="text"
                id="nota-ongkir"
                placeholder="0"
                style="width: 140px; text-align: right"
                oninput="updatePreview()"
              />
            </div>
            <div class="summary-row total">
              <label>Kekurangan</label>
              <input
                type="text"
                id="nota-kekurangan"
                placeholder="â€”"
                style="
                  width: 140px;
                  text-align: right;
                  font-weight: 700;
                  color: #1a5fb4;
                "
                readonly
              />
            </div>
          </div>

          <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ FORM SURAT JALAN â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div id="form-sj" style="display: none">
            <p class="section-title">Info Dokumen</p>
            <div class="form-row">
              <div class="form-group">
                <label>No. Surat Jalan</label>
                <div class="nomor-row">
                  <input
                    type="text"
                    id="sj-nomor"
                    placeholder="SJ-202502-001"
                  />
                  <button
                    class="btn-sm"
                    onclick="generateNewNomor('sj_counter', 'SJ', 'sj-nomor')"
                  >
                    â†» Baru
                  </button>
                  <button
                    class="btn-sm"
                    title="Kembali ke nomor sebelumnya"
                    onclick="decrementSequence('sj_counter', 'SJ', 'sj-nomor')"
                  >
                    â¬…ï¸
                  </button>
                  <button
                    class="btn-sm btn-danger-outline"
                    onclick="resetSequence('sj_counter', 'SJ', 'sj-nomor')"
                  >
                    ğŸ—‘ï¸ Reset
                  </button>
                </div>
              </div>
            </div>
            <div class="form-row cols-2">
              <div class="form-group">
                <label>No. Surat</label>
                <input
                  type="text"
                  id="sj-nosurat"
                  placeholder="xxx/RCG/II/2025"
                />
              </div>
              <div class="form-group">
                <label>Tanggal</label>
                <input type="date" id="sj-tgl" />
              </div>
            </div>
            <div class="form-row cols-2">
              <div class="form-group">
                <label>No. PO</label>
                <input type="text" id="sj-po" placeholder="PO-xxx" />
              </div>
              <div class="form-group">
                <label>Kepada Yth.</label>
                <input
                  type="text"
                  id="sj-kepada"
                  placeholder="Nama customer / toko"
                />
              </div>
            </div>

            <p class="section-title">Daftar Barang</p>
            <div class="items-form-wrap">
              <table class="items-form-table">
                <thead>
                  <tr>
                    <th style="width: 22px">#</th>
                    <th style="width: 60px">Kode</th>
                    <th>Nama Barang</th>
                    <th style="width: 48px">Qty</th>
                    <th style="width: 52px">Satuan</th>
                    <th style="width: 24px"></th>
                  </tr>
                </thead>
                <tbody id="sj-items-tbody"></tbody>
              </table>
            </div>
            <button class="btn-add-row" onclick="addSJRow()">
              + Tambah Barang
            </button>

            <p class="section-title">Keterangan</p>
            <div class="form-group">
              <label>Catatan Pengiriman</label>
              <textarea
                id="sj-catatan"
                rows="3"
                placeholder="Keterangan tambahan / catatan pengiriman..."
                style="resize: vertical"
                oninput="updatePreview()"
              ></textarea>
            </div>
          </div>
        </div>
        <!-- /panel-form-inner -->

        <!-- ACTION BAR -->
        <div class="action-bar">
          <button class="btn-primary" onclick="window.print()">
            ğŸ–¨ï¸ Print / PDF
          </button>
          <button
            class="btn-preview-mobile btn-secondary"
            onclick="openPreviewModal()"
          >
            ğŸ‘ Preview
          </button>
          <button class="btn-secondary" onclick="resetForm()">â†º Reset</button>
        </div>
      </div>

      <!-- â•â•â•â• RIGHT: PREVIEW PANEL â•â•â•â• -->
      <div class="panel-preview" id="panel-preview">
        <p class="preview-label">ğŸ‘ Preview Dokumen</p>
        <div id="doc-scale-wrapper">
          <div id="preview-container"></div>
        </div>
      </div>
    </div>
    <!-- /app-body -->

    <!-- â•â• MODAL PREVIEW (mobile) â•â• -->
    <div
      class="preview-modal-overlay"
      id="preview-modal"
      onclick="handleModalClick(event)"
    >
      <div class="preview-modal-bar">
        <button class="btn-modal-print" onclick="window.print()">
          ğŸ–¨ï¸ Print / Save PDF
        </button>
        <button class="btn-modal-close" onclick="closePreviewModal()">
          âœ• Tutup
        </button>
      </div>
      <div class="preview-modal-doc" id="modal-doc-wrapper">
        <div id="modal-preview-container"></div>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      // â”€â”€ Scale desktop preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function applyDocScale() {
        const wrapper = document.getElementById("doc-scale-wrapper");
        const panel = document.getElementById("panel-preview");
        if (!wrapper || !panel) return;
        const panelW = panel.clientWidth - 48;
        const docW = wrapper.scrollWidth;
        const scale = Math.min(1, panelW / docW);
        wrapper.style.transform = `scale(${scale})`;
        wrapper.style.marginBottom = `${wrapper.scrollHeight * scale - wrapper.scrollHeight}px`;
      }
      window.addEventListener("resize", applyDocScale);

      const _origUpdate = window.updatePreview;
      window.updatePreview = function () {
        _origUpdate();
        setTimeout(applyDocScale, 10);
        if (document.getElementById("preview-modal").classList.contains("open"))
          syncModalPreview();
      };
      document.addEventListener("DOMContentLoaded", () =>
        setTimeout(applyDocScale, 50),
      );

      // â”€â”€ Modal preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function syncModalPreview() {
        document.getElementById("modal-preview-container").innerHTML =
          document.getElementById("preview-container").innerHTML;
        applyModalScale();
      }

      function applyModalScale() {
        const wrapper = document.getElementById("modal-doc-wrapper");
        if (!wrapper) return;
        const avail = Math.min(window.innerWidth - 32, 700);
        const docW = wrapper.scrollWidth;
        const scale = Math.min(1, avail / docW);
        wrapper.style.transform = `scale(${scale})`;
        wrapper.style.marginBottom = `${wrapper.scrollHeight * scale - wrapper.scrollHeight}px`;
      }

      function openPreviewModal() {
        syncModalPreview();
        document.getElementById("preview-modal").classList.add("open");
        document.body.style.overflow = "hidden";
      }

      function closePreviewModal() {
        document.getElementById("preview-modal").classList.remove("open");
        document.body.style.overflow = "";
      }

      function handleModalClick(e) {
        if (e.target === document.getElementById("preview-modal"))
          closePreviewModal();
      }

      window.addEventListener("resize", applyModalScale);
    </script>
  </body>
</html>
